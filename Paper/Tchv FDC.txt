CP/M для Радио-86 РК
**** *** ******** **

Операционная система CP/M по праву завоевала ведущее положение среди ОС для 8-битных компьютеров. Вниманию читателей представляется эта ОС для Радио-86 РК. Установка CP/M поможет вдохнуть новую жизнь в заслуженного ветерана отечественного компьютеростроения и даст возможность использовать громадный объем накопленного программного обеспечения, исчисляемого десятками и сотнями прикладных пакетов, трансляторов, игр. Следует отметить, что сам компьютер, с его достаточно быстрым текстовым режимом и контроллером ПДП, как нельзя лучше подходит для реализации CP/M-машины.
Для установки CP/M автором был разработан контроллер дисковода на БИС К1818ВГ93 (далее просто ВГ93). Этот контроллер представляет собой упрощенный вариант бета диск интерфейса для ZX-SPECTRUM, в который введена возможность обмена с компьютером в режиме прямого доступа в память (ПДП). Обмен с компьютером в режиме ПДП позволяет освободить процессор от выполнения рутинных операций по пересылке информации и, тем самым, существенно повысить производительность дисковых операций. Реально, достигнута производительность, соответствующая физической скорости обмена с диском (около 22 кбайт/сек).
ОС CP/M является мобильной операционной системой, это значит что для установки ее на новый компьютер требуется переписать сравнительно небольшую часть операционной системы, в то время как остальная часть и все богатейшее программное обеспечение остается без изменений. Машинно-зависимая часть CP/M называется BIOS - Basic Input/Output System - базовая система ввода-вывода. Именно она и была написана заново, для того, чтобы работала CP/M. В реализованной версии BIOS полностью использованы преимущества обмена с диском по ПДП. Использование ПДП позволяет ввести асинхронное параллельное выполнение дисковых операций, т.е. фоновую запись и упреждающее чтение.
Логический формат диска CP/M предполагает сектора размером 128 байт, в то время как современные физические форматы диска имеют размер сектора 512 или 1024 байта. Такое несоответствие требует довольно сложной и нетривиальной работы по блокированию/деблокированию секторов, что очень сильно снижает производительность дисковой системы. При программном обмене даже самому быстрому процессору, тем более 8080 на 1.77 Мгц, не остается времени для выполнения этих операций до момента чтения следующего сектора, если они следуют подряд. Это обстоятельство заставляет вводить чередование секторов (interleaving), что, в свою очередь, дополнительно снижает скорость обмена с диском минимум в два раза.
Использование ПДП позволяет запустить чтение следующего сектора во врем обработки текущего (так называемое опережающее чтение). Если следующее обращение будет к этому сектору, то он УЖЕ будет находится в памяти и никакого ожидания не потребуется! Теоретически, вероятность попадания не может быть ниже 75%, а реально она достигает 90% и более. При таком положении вещей можно обойтись вовсе без чередования, а это существенно ускоряет дисковые операции. Более того, такое решение приводит к тому, что трансляторы, как правило, вообще не ожидают окончания обмена с диском, т.к. требуемые данные УЖЕ ПРОЧИТАНЫ. Реально, скорость трансляции с диска на диск равна скорости трансляции на электронном диске!!! Введена также фоновая запись, т.е. после заполнения буфера сектора инициализируется запись его в фоновом режиме, а в основном потоке программы заполняется другой буфер. Затем буфера меняются местами.
Теперь более подробно о контроллере дисковода.
Для подключения контроллера требуется небольшая переделка компьютера. Переделка заключается в установке типовой схемы включения контроллера ПДП. Желательно ввести микросхему К589АП16, а также установить дополнительный разъем для дискового контроллера. Микросхема К589АП16 управляет коммутацией шин управления (либо от процессора к контроллеру ПДП, либо от контроллера ПДП к памяти и внешним устройствам). Схема переделки приведена на рис.1. Контроллер дисковода подключается к каналу 2 ПДП. Один канал остается свободным, что позволяет подключить к контроллеру ПДП еще одно устройство, например, контроллер винчестера или локальной сети.
Принципиальная схема контроллера представлена на рис.2.
Схема сопряжения ВГ93 с дисководом не отличается от общепринятой. Интерес представляет схема сопряжения БИС с контроллером ПДП. Элемент D15.3 обеспечивает выборку БИС по сигналу ~DACK, логические элементы D5.2, D13.1, D13.2, D13.4  выставляют адрес 11b при активном сигнале ~DACK, что соответствует регистру данных БИС контроллера дисковода. Сигнал DRQ с выхода БИС заведен на вход DRQ2 контроллера ПДП.
Режим ПДП функционирует следующим образом: при готовности ВГ93 к передаче нового байта появляется 1 на выходе DRQ БИС. Контроллер ПДП запрашивает шину процессора сигналом BUSRQ и, получив подтверждения сигналом ~BUSEN, выбирает БИС контроллера сигналом ~DACK. Сигнал ~BUSEN управляет также коммутацией шины управления, подключая ее к контроллеру ПДП. Контроллер ПДП проводит обмен между ОЗУ и БИС контроллера дисковода, используя сигналы ~MEMRD, ~MEMWR, ~IORD, ~IOWR. После проведения цикла обмена ВГ93 с памятью, БИС снимает сигнал DRQ. Далее ситуация повторяется.
Отменим, что введение ПДП не запрещает программного обмена, но типовой скорости Радио-86 РК недостаточно для его реализации, ди и необходимость в нем сомнительна.
На микросхеме D3 и элементе D4.1 собран дополнительный 5-ти битный регистр, предназначенный для управления дисководом - выборки конкретного накопителя, установки формата записи (MFM или  FM) и выборки стороны накопителя. Логические элементы D2.2, D2.4, D6.2 и D1.5 формируют сигнал записи в этот регистр. Сигнал активен при А2=1 ~SEL=0 ~WR=0. Допускается только запись, чтение не предусмотрено.
Имеется также другой двухбитный регистр D9.2, из которого можно только читать информацию. На него заведены сигналы DRQ и INRQ. Сигнал выборки из него формируется логическими элементами D2.1 и D1.6.  Сигнал активен при А2=1 ~SEL=0 ~RD=0. Назначение конкретных битов этих двух регистров приведено в табл.1 (A7 - DRQ, A6 - INRQ).
Формат данных этих двух регистров cоответствует аналогичным регистрам beta disk interface, что позволяет при использовании дополнительной достаточно простой схемы подключить данный контроллер к ZX-SPECTRUM.
Необходимо сказать, что контроллер дисковода непрерывно совершенствуется, поэтому описанный контроллер является одним из промежуточных вариантов. Автор оставляет за собой право на дальнейшее совершенствование изделия, не ухудшающее его характеристик.
(с) TCHV, 1990-93
